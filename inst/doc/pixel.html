<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Vincent Guyader" />

<meta name="date" content="2016-08-27" />

<title>tipixel</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">tipixel</h1>
<h4 class="author"><em>Vincent Guyader</em></h4>
<h4 class="date"><em>2016-08-27</em></h4>



<p><code>tipixel</code> est un package qui permet de reconstruire une image au format jpeg à partir d’autres images miniaturisées. Le résultat est alors une mosaïque d’images qui représente l’image originelle. L’idée est de découper l’image originelle en plusieurs <code>pixel</code>, en quadrillant l’image, et d’ensuite remplacer chaque pixel par une autre image (appelée tuile) aux coloris proches. Il est donc nécessaire d’avoir non seulement une image à transformer, mais aussi une base d’autres images qui seront utilisées pour reconstruire l’image originelle (<code>target</code>).</p>
<p>Mathématiquement, il s’agit de rechercher, pour chaque <code>pixel</code>, dans l’espace à 3 dimensions des couleurs primaires (R,V,B), le/les plus proches voisins dans la base d’images. Ce type de calcul peut rapidement se complexifier et devenir assez long, un important effort a été réalisé afin d’optimiser les temps de calcul - en permettant par exemple l’usage des différents coeurs de la machine.</p>
<p>À VENIR : <em>réaliser les calculs non plus in-memory mais directement sur le disque dur. L’objectif est de permettre aux ordinateurs dispoosant de trop peu de ram de générer de gros fichiers image</em></p>
<p>(décrire les différentes étapes ? se constituer une base puis construire une nouvelle image à partir de cette dernière)</p>
<div id="creation-dune-base-dimage" class="section level2">
<h2>Création d’une base d’image</h2>
<p>La fonction <code>genere_base</code> permet de lire le contenu d’un dossier afin d’en constituer une base de tuiles. Elle incorpore les images au format jpeg et ne sélectionne que les fichiers .jpeg ou .jpg via un filtre sur l’extension. Le paramètre <code>redim</code> permet de définir la dimension (hauteur x largeur) des tuiles, c’est l’un des critères les plus impactants sur la taille finale de l’image reconstruite.</p>
<p>Le package est fourni avec une base d’exemple de 54 images libres de droit. Il est possible de l’utiliser avec le code suivant :</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tipixel)
base &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">find.package</span>(<span class="st">'tipixel'</span>),<span class="st">'base'</span>) <span class="co"># identifier le chemin de stockage de la base</span>
les_tuiles &lt;-<span class="st"> </span><span class="kw">genere_base</span>(base,<span class="dt">redim=</span><span class="kw">c</span>(<span class="dv">100</span>,<span class="dv">100</span>),<span class="dt">progress =</span> <span class="st">&quot;text&quot;</span>)
les_tuiles</code></pre></div>
<p>L’objet <code>les_tuiles</code> contient l’ensemble de la base d’images et constitue maintenant un tout indépendant des fichiers physiques d’image sur votre ordinateur. Il est possible de sauvegarder/réimporter cet objet R avec les fonctions classiques de R du type <code>save</code> / <code>load</code> ou <code>saveRDS</code>,<code>readRDS</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">saveRDS</span>(les_tuiles,<span class="st">&quot;mes_tuiles.rds&quot;</span>)
les_tuiles &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;mes_tuiles.rds&quot;</span>)</code></pre></div>
<p>Lorsque le nombre de tuiles dans la base est trop important il peut être judicieux de ne pas précharger les images, cela permet de garder de la mémoire vive disponible pour les calculs et la création de l’image finale.</p>
<p>Cela permet aussi de travailler avec une base d’image dont la taille dépasse la capacité de mémoire vive de la machine. Dans ce cas, le paramètre <code>preload</code> doit être passé à <code>FALSE</code> et il faut conserver les fichiers jpeg en lieu et place sur la machine.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">les_tuiles_non_charge &lt;-<span class="st"> </span><span class="kw">genere_base</span>(base,<span class="dt">redim=</span><span class="kw">c</span>(<span class="dv">100</span>,<span class="dv">100</span>),<span class="dt">preload =</span> <span class="ot">FALSE</span>,<span class="dt">progress =</span> <span class="st">&quot;text&quot;</span>)
les_tuiles_non_charge</code></pre></div>
</div>
<div id="import-de-limage-cible" class="section level2">
<h2>Import de l’image cible</h2>
<p>Il vous faut récupérer le chemin de l’image en chaîne de caractère. Sous windows, attention aux <code>/</code> et <code>\</code> R s’attend à avoir une chaîne du type <code>&quot;/home/vincent/image.jpg&quot;</code> et renverra un message d’erreur pour <code>&quot;C:\Users\Vincent\image.jpg&quot;</code>, il faudra taper <code>&quot;C:\\Users\\Vincent\\image.jpg&quot;</code> ou encore <code>&quot;C:/Users/Vincent/image.jpg&quot;</code>.</p>
<p>Dans l’exemple nous allons “pixeliser” une des images de la base :</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">img &lt;-<span class="st"> </span>base::<span class="kw">sample</span>(<span class="dt">x=</span><span class="kw">list.files</span>(base,<span class="dt">full.names =</span> <span class="ot">TRUE</span>),<span class="dt">size=</span><span class="dv">1</span>) <span class="co"># une image au hasard</span>
<span class="kw">print</span>(img)
<span class="kw">plotraster</span>(<span class="kw">aperm</span>(jpeg::<span class="kw">readJPEG</span>(img),<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">3</span>)))<span class="co"># permet d'afficher l'image en tant que graphique dans une fenêtre de plot</span></code></pre></div>
</div>
<div id="la-fonction-pixel" class="section level2">
<h2>La fonction pixel</h2>
<p>La fonction <code>pixel</code> est la principale fonction du package. Pour l’utiliser un certain nombre de paramètres sont obligatoires :</p>
<ul>
<li><p><code>file</code> pointe vers l’image à pixeliser.</p></li>
<li><p><code>lig</code> et <code>col</code> définissent un quadrillage de l’image d’origine grâce à un nombre de lignes et de colonnes respectivement. Plus le maillage est fin, plus la résolution sera fine et le résultat satisfaisant, mais plus l’image <code>target</code> sera volumineuse (en dimension et en taille)</p></li>
<li><p><code>base</code> pointe vers la base</p></li>
<li><p><code>target</code> reçoit une chaîne de caractères qui spécifie le nom du fichier de sortie qui sera généré.</p></li>
<li><p><code>affich</code> affiche l’image pixelisée dans la fenêtre de plot (plus long)</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">pixel</span>(<span class="dt">file=</span>img,<span class="dt">lig=</span><span class="dv">5</span>,<span class="dt">col=</span><span class="dv">5</span>,<span class="dt">base=</span>les_tuiles,<span class="dt">target=</span><span class="st">'dessin.jpg'</span>,<span class="dt">affich =</span> <span class="ot">TRUE</span>)
<span class="kw">pixel</span>(<span class="dt">file=</span>img,<span class="dt">lig=</span><span class="dv">50</span>,<span class="dt">col=</span><span class="dv">50</span>,<span class="dt">base=</span>les_tuiles,<span class="dt">target=</span><span class="st">'dessin2.jpg'</span>,<span class="dt">affich=</span><span class="ot">TRUE</span>)</code></pre></div>
<!-- ```{r fig.width=8, fig.height=8,echo=FALSE,eval=FALSE} -->
<!-- require(png) -->
<!-- require(grid) -->
<!-- jj<-jpeg(filename = '/mnt/docs/ThinkR/package public/tipixel/dessin2.jpg') -->
<!--  grid.raster(jpeg(filename = 'dessin2.jpg')) -->
<!-- ``` -->
<p>Pour gagner en vitesse il faut utiliser au maximum les coeurs de votre machine, <code>thread</code> est l’argument qui correspond au nombre de thread sur lesquels paralleliser les calculs : c’est un paramètre à adapter aux capacités de la machine. <em>Si vous n’avez que 2 coeurs, inutile de lancer 8 thread…</em></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">pixel</span>(<span class="dt">file=</span>img,<span class="dt">lig=</span><span class="dv">100</span>,<span class="dt">col=</span><span class="dv">100</span>,<span class="dt">base=</span>les_tuiles,<span class="dt">target=</span><span class="st">'dessin4.jpg'</span> ,<span class="dt">open=</span><span class="ot">TRUE</span>,<span class="dt">parallel =</span> <span class="ot">TRUE</span>,<span class="dt">thread =</span> <span class="dv">2</span>)</code></pre></div>
<p>Si vous utilisez une base de tuiles non préchargées, alors il faut préciser le paramètre <code>redim</code> afin de définir les dimensions des tuiles :</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">pixel</span>(<span class="dt">file=</span>img,<span class="dt">lig=</span><span class="dv">50</span>,<span class="dt">col=</span><span class="dv">50</span>,<span class="dt">base=</span>les_tuiles_non_charge,<span class="dt">target=</span><span class="st">'dessin5.jpg'</span> ,<span class="dt">open=</span><span class="ot">TRUE</span>,<span class="dt">parallel =</span> <span class="ot">TRUE</span>,<span class="dt">thread =</span> <span class="dv">2</span>,<span class="dt">redim =</span> <span class="kw">c</span>(<span class="dv">20</span>,<span class="dv">20</span>))</code></pre></div>
<p>Le parametre <code>random</code> permet de modifier la methode de choix des tuiles. random permet de tirer au sort parmi les meilleurs tuiles, cela permet d’éviter d’avoir trop de fois les meme tuiles dans l’image finale. Pour que cela fonctionne mieux, il faut passer le parametre <code>doublon</code> à <code>TRUE</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">pixel</span>(<span class="dt">file=</span>img,<span class="dt">lig=</span><span class="dv">100</span>,<span class="dt">col=</span><span class="dv">100</span>,<span class="dt">base=</span>les_tuiles_non_charge,<span class="dt">target=</span><span class="st">'dessin6.jpg'</span> ,<span class="dt">open=</span><span class="ot">TRUE</span>,<span class="dt">parallel =</span> <span class="ot">TRUE</span>,<span class="dt">thread =</span> <span class="dv">2</span>,<span class="dt">doublon=</span><span class="ot">TRUE</span>,<span class="dt">random=</span><span class="dv">2</span>)</code></pre></div>
<p>En cas d’insuffisance de RAM disponible vous pouvez au choix :</p>
<ul>
<li><p>Acheter de la RAM supplémentaire</p></li>
<li><p>Fermer les autres programmes qui consomment de la RAM</p></li>
<li><p>Supprimer de votre session R les objets en mémoire inutiles</p></li>
<li><p>Diminuer le nombre de lignes/colonnes du maillage de l’image (<code>file</code>)</p></li>
<li><p>Diminuer la dimension (hauteur et largeur) des tuiles</p></li>
</ul>
<p>Dans une seconde version je proposerais une autre approche qui permettra de travailler sur le disque dur, ca sera plus long , mais ca marchera tant que le disque dur n’est pas plein.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
